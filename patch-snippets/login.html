<script>
  if (window.ap && /AliApp\(AP\//ig.test(window.navigator.userAgent)) {
    // 需要重定向的地址
    var R_URL =
      'https://air.1688.com/apps/alim/alipay-hysc-redirect/index.html';

    var R_PASS_URL =
      'https://m.1688.com/pass.html?done=' + encodeURIComponent(R_URL);

    // cn login cookie id
    var CN_LOGIN_COOKIE_ID = '__cn_logon_id__';

    // @see https://stackoverflow.com/questions/14573223/set-cookie-and-get-cookie-with-javascript
    function getCookie(name) {
      var nameEQ = name + "=";
      var ca = document.cookie.split(';');
      for (var i = 0; i < ca.length; i++) {
        var c = ca[i];
        while (c.charAt(0) == ' ') c = c.substring(1, c.length);
        if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length, c.length);
      }
      return null;
    }

    // !getCookie(CN_LOGIN_COOKIE_ID)
    if (true) {

      (lib && lib.mtop) && (
        lib.mtop.config.prefix = 'h5api',
        lib.mtop.config.subDomain = 'm',
        lib.mtop.config.mainDomain = '1688.com'
      );

      // 继续尝试使用接口获取
      var loginPromise = lib && lib.mtop && lib.mtop.request({
        api: 'mtop.1688.wireless.sync.cookie',
        v: '1.0',
        data: {},
        ecode: 1
      });

      loginPromise && loginPromise.then && loginPromise
        .then(function (ret) {
          console.log('get cookie mtop data: ', ret);

          if (ret.data.success === 'false') {
            window.ap.redirectTo({
              url: 'alipays://platformapi/startapp?appId=20000067&url=' + encodeURIComponent(R_PASS_URL) +
                '&showLoading=NO&pullRefresh=NO&transparentTitle=none&showOptionMenu=YES&showProgress=YES'
            });
          }
        }, function (error) {
          // pass
          console.log('get cookie mtop error.', error);
        });

      // FIXME: ios popWindow 行为有问题
      // window.ap.pushWindow({
      //   url: 'https://m.1688.com/pass.html',
      //   data: {
      //     done: encodeURIComponent(R_URL)
      //   },
      //   // 容器启动参数
      //   params: {
      //     showLoading: "YES",
      //     transparentTitle: "none",
      //     pullRefresh: "YES",
      //     showOptionMenu: "YES"
      //   }
      // });

      // window.ap.popWindow();
    }
  }
</script>