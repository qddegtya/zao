<script>
  if (window.ap && /AliApp\(AP\//ig.test(window.navigator.userAgent)) {
    var FROM_FLAG = 'passport';

    // 需要重定向的地址
    var R_URL =
      'https://air.1688.com/apps/alim/alipay-hysc/ap.html?__pageId__=6370&tracelog=20180328zfb';

    if (lib.env.params.from === FROM_FLAG) {
      window.ap.redirectTo({
        url: 'alipays://platformapi/startapp?appId=20000067&url=' + encodeURIComponent(R_URL) +
          '&showLoading=YES&pullRefresh=YES&transparentTitle=auto&bounceTopColor=15009827&bounceBottomColor=15009827&showOptionMenu=NO&showProgress=NO'
      });
    }

    var R_PASS_URL =
      'https://m.1688.com/pass.html?done=' + R_URL + '&from=' + FROM_FLAG;

    // cn login cookie id
    var CN_LOGIN_COOKIE_ID = '__cn_logon_id__';

    // @see https://stackoverflow.com/questions/14573223/set-cookie-and-get-cookie-with-javascript
    function getCookie(name) {
      var nameEQ = name + "=";
      var ca = document.cookie.split(';');
      for (var i = 0; i < ca.length; i++) {
        var c = ca[i];
        while (c.charAt(0) == ' ') c = c.substring(1, c.length);
        if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length, c.length);
      }
      return null;
    }

    if (!getCookie(CN_LOGIN_COOKIE_ID)) {

      window.ap.redirectTo({
        url: 'alipays://platformapi/startapp?appId=20000067&url=' + encodeURIComponent(R_PASS_URL) +
          '&showLoading=YES&pullRefresh=NO&transparentTitle=none&showOptionMenu=YES&showProgress=NO'
      });

      // FIXME: ios popWindow 行为有问题
      // window.ap.pushWindow({
      //   url: 'https://m.1688.com/pass.html',
      //   data: {
      //     done: encodeURIComponent(R_URL)
      //   },
      //   // 容器启动参数
      //   params: {
      //     showLoading: "YES",
      //     transparentTitle: "none",
      //     pullRefresh: "YES",
      //     showOptionMenu: "YES"
      //   }
      // });

      // window.ap.popWindow();
    }
  }
</script>